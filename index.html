<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Juego de Acciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffff; --text:#1a1a1a; --muted:#666;
      --primary:#1f6feb; --galicia:#e11d48; --marine:#FF8C00; --gm:#2563eb; --ypf:#222222;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: Inter, system-ui, Arial, sans-serif;
      background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; align-items:center; min-height:100vh;
    }
    h1{font-size:1.6rem; margin:16px 12px}
    .container{width:100%; max-width:1100px; padding:12px; display:flex; flex-direction:column; gap:16px;}
    .card{background:var(--card); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.08); padding:16px;}
    #players, #controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center;}
    .btn{padding:12px 18px; border:none; border-radius:10px; cursor:pointer; font-weight:600; background:#f0f0f5; color:#111;}
    .btn.primary{background:var(--primary); color:#fff}
    .btn.warning{background:#f59e0b; color:#111}
    .legend{display:flex; gap:12px; justify-content:center; flex-wrap:wrap; color:var(--muted); font-size:.95rem;}
    .legend .dot{width:14px; height:14px; border-radius:3px; display:inline-block; margin-right:6px}
    #chart-wrapper{height:70vh; min-height:420px; background:#fff; border-radius:16px; padding:12px; box-shadow: inset 0 0 0 1px #eee;}
    #chart-wrapper canvas{width:100% !important; height:100% !important}
    .modal{position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; padding:20px;}
    .modal-content{background:#fff; border-radius:16px; padding:18px; width:100%; max-width:560px; box-shadow:0 20px 40px rgba(0,0,0,0.2);}
    .modal-title{font-weight:700; margin-bottom:12px}
    .grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
    @media (min-width:640px){ .grid{grid-template-columns:repeat(4,minmax(0,1fr))} }
    #individual-view{display:none; grid-template-columns:1fr 1fr; gap:12px;}
    #individual-view .panel{background:#fff; border-radius:12px; padding:10px;}
    #individual-view .panel h3{margin:6px 0 8px; font-size:1rem;}
    #individual-view canvas{width:100% !important; height:260px !important;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Juego de Acciones 📈</h1>

    <div class="card">
      <div id="players">
        <button class="btn" onclick="setPlayers(2)">2 jugadores</button>
        <button class="btn" onclick="setPlayers(3)">3 jugadores</button>
        <button class="btn" onclick="setPlayers(4)">4 jugadores</button>
        <button class="btn" onclick="setPlayers(5)">5 jugadores</button>
      </div>
    </div>

    <div class="card">
      <div class="legend">
        <span><span class="dot" style="background:var(--galicia)"></span>Galicia</span>
        <span><span class="dot" style="background:var(--marine)"></span>Marine</span>
        <span><span class="dot" style="background:var(--gm)"></span>General Motors</span>
        <span><span class="dot" style="background:var(--ypf)"></span>YPF</span>
      </div>
      <div id="chart-wrapper">
        <canvas id="gameChart"></canvas>
      </div>
    </div>

    <div class="card">
      <div id="controls">
        <button class="btn primary" onclick="nextTurn()">Siguiente turno</button>
        <button class="btn warning" onclick="undo()">Deshacer</button>
        <button class="btn" onclick="toggleIndividualView()">Vista individual</button>
      </div>
    </div>

    <div id="individual-view" class="card"></div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <div id="modal-content"></div>
    </div>
  </div>

<script>
let numPlayers = 2;
let totalTurns = 20;
let currentTurn = 0;
let history = [];
let individualCharts = [];

const actions = {
  "Galicia": mkAction('--galicia'),
  "Marine": mkAction('--marine'),
  "General Motors": mkAction('--gm'),
  "YPF": mkAction('--ypf')
};
function mkAction(varName){
  return {
    color: getVar(varName),
    values: [100],
    minSquares: [false],
    maxSquares: [false],
    overflow: [0],
    pointStyle: ['circle'],
    pointRadius: [4],
    pointBorderWidth: [1]
  };
}
function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

const ctx = document.getElementById('gameChart').getContext('2d');

// Plugin para texto +diferencia sobre 250
const overflowLabelPlugin = {
  id: 'overflowLabelPlugin',
  afterDatasetsDraw(chart) {
    const { ctx } = chart;
    chart.data.datasets.forEach((ds, di) => {
      const meta = chart.getDatasetMeta(di);
      meta.data.forEach((point, idx) => {
        const name = ds.label;
        const over = actions[name].overflow[idx] || 0;
        const isMax = actions[name].maxSquares[idx] || false;
        if (isMax && over > 0) {
          const { x, y } = point.tooltipPosition();
          ctx.save();
          ctx.fillStyle = '#111';
          ctx.font = '600 12px Inter, Arial';
          ctx.textAlign = 'center';
          ctx.fillText(`+${over}`, x, y - 14);
          ctx.restore();
        }
      });
    });
  }
};

let chart = new Chart(ctx, {
  type: 'line',
  data: buildChartData(),
  options: {
    responsive: true,
    maintainAspectRatio: false,
    layout: { padding: { top: 44 } }, // margen superior para que se vea el texto
    plugins: {
      legend: { display: false },
      tooltip: {
        mode: 'nearest',
        callbacks: { label: (item) => `${item.dataset.label}: ${item.parsed.y}` }
      }
    },
    scales: {
      x: {
        title: { display: true, text: 'Turnos', color: '#333', font: { weight: '600' } },
        grid: { color: '#eee' },
        ticks: { color: '#333' }
      },
      y: {
        min: 10, max: 250,
        title: { display: true, text: 'Valor de la acción', color: '#333', font: { weight: '600' } },
        grid: { color: '#eee' },
        ticks: { color: '#333' }
      }
    }
  },
  plugins: [overflowLabelPlugin]
});

function buildChartData(){
  const labels = Array.from({length: totalTurns}, (_, i) => i + 1);
  const datasets = Object.keys(actions).map(name => {
    const color = actions[name].color;
    return {
      label: name,
      data: actions[name].values,
      borderColor: color,
      backgroundColor: color,
      borderWidth: 3,
      tension: 0,
      pointStyle: actions[name].pointStyle,
      pointRadius: actions[name].pointRadius,
      pointBorderWidth: actions[name].pointBorderWidth,
      pointBorderColor: color
    };
  });
  return { labels, datasets };
}

// Recalcula estilos de puntos (cuadrados en min/max)
function recalcPointStyles(name){
  const a = actions[name];
  a.pointStyle = a.values.map((v, i) =>
    (a.minSquares[i] || a.maxSquares[i]) ? 'rect' : 'circle'
  );
  a.pointRadius = a.values.map((v, i) =>
    (a.minSquares[i] || a.maxSquares[i]) ? 7 : 4
  );
  a.pointBorderWidth = a.values.map((v, i) =>
    (a.minSquares[i] || a.maxSquares[i]) ? 3 : 1
  );
}

function setPlayers(n){
  numPlayers = n;
  totalTurns = n * 10;
  resetGame();
}

function resetGame(){
  currentTurn = 0;
  history = [];
  for (let key in actions){
    actions[key] = mkAction(colorVarFor(key));
  }
  updateChart(true);
}

function colorVarFor(name){
  if (name === 'Galicia') return '--galicia';
  if (name === 'Marine') return '--marine';
  if (name === 'General Motors') return '--gm';
  return '--ypf';
}

function updateChart(){
  for (let key in actions) recalcPointStyles(key);
  chart.data = buildChartData();
  chart.update();
  syncIndividualCharts();
}

function nextTurn(){
  if (currentTurn >= totalTurns) return;
  showActionSelection();
}

function undo(){
  if (history.length === 0) return;
  history.pop();
  for (let key in actions){
    if (actions[key].values.length > 1){
      actions[key].values.pop();
      actions[key].minSquares.pop();
      actions[key].maxSquares.pop();
      actions[key].overflow.pop();
    }
  }
  currentTurn = Math.max(0, currentTurn - 1);
  updateChart();
}

function showActionSelection(){
  const modal = document.getElementById('modal');
  const content = document.getElementById('modal-content');
  content.innerHTML = `
    <div class="modal-title">Elige una acción</div>
    <div class="grid" id="action-grid"></div>
    <p class="hint">Selecciona la acción y luego la operación.</p>
  `;
  const grid = content.querySelector('#action-grid');
  Object.keys(actions).forEach(name => {
    const btn = document.createElement('button');
    btn.textContent = name;
    btn.className = 'btn';
    btn.style.background = actions[name].color;
    btn.style.color = '#fff';
    btn.onclick = () => showOperationSelection(name);
    grid.appendChild(btn);
  });
  modal.style.display = 'flex';
}

function showOperationSelection(action){
  const content = document.getElementById('modal-content');
  content.innerHTML = `
    <div class="modal-title">${action}: Elige operación</div>
    <div class="grid" id="op-grid"></div>
    <p class="hint">+100 no requiere perdedora. +40 / +60 / x2 sí requieren.</p>
  `;
  const grid = content.querySelector('#op-grid');
  ["+40","+60","+100","x2"].forEach(op=>{
    const btn = document.createElement('button');
    btn.textContent = op;
    btn.className = 'btn';
    btn.onclick = ()=> applyOperation(action, op);
    grid.appendChild(btn);
  });
}

function applyOperation(action, op){
  const modal = document.getElementById('modal');
  if (op === '+100'){
    for (let key in actions){
      let last = lastValue(key);
      if (key === action) last = last + 100;
      else last = last - 10;
      pushValue(key, last);
    }
    currentTurn++;
    history.push({action, op});
    modal.style.display = 'none';
    updateChart();
    return;
  }
  showLossSelection(action, op);
}

function showLossSelection(action, op){
  const modal = document.getElementById('modal');
  const content = document.getElementById('modal-content');
  content.innerHTML = `
    <div class="modal-title">Elige acción que pierde</div>
    <div class="grid" id="loss-grid"></div>
  `;
  const grid = content.querySelector('#loss-grid');
  Object.keys(actions).forEach(name=>{
    if (name !== action){
      const btn = document.createElement('button');
      btn.textContent = name;
      btn.className = 'btn';
      btn.style.background = actions[name].color;
      btn.style.color = '#fff';
      btn.onclick = () => finalizeOperation(action, op, name);
      grid.appendChild(btn);
    }
  });
  modal.style.display = 'flex';
}

function finalizeOperation(action, op, loser){
  for (let key in actions){
    let last = lastValue(key);
    if (key === action){
      if (op === '+40') last = last + 40;
      else if (op === '+60') last = last + 60;
      else if (op === 'x2') last = roundIfEndsIn5(last * 2);
    } else if (key === loser){
      if (op === '+40') last = last - 30;
      else if (op === '+60') last = last - 50;
      else if (op === 'x2') last = roundIfEndsIn5(last / 2);
    }
    pushValue(key, last);
  }
  currentTurn++;
  history.push({action, op, loser});
  document.getElementById('modal').style.display = 'none';
  updateChart();
}

function lastValue(key){ return actions[key].values[actions[key].values.length - 1]; }

function pushValue(key, raw){
  let minSquare = false, maxSquare = false, overflow = 0;
  let val = Math.round(raw);

  if (val < 10){ val = 10; minSquare = true; }
  else if (val > 250){ overflow = val - 250; val = 250; maxSquare = true; }

  const a = actions[key];
  a.values.push(val);
  a.minSquares.push(minSquare);
  a.maxSquares.push(maxSquare);
  a.overflow.push(overflow);
}

// Redondeo especial si termina en 5 hacia la decena inferior
function roundIfEndsIn5(val){
  const n = Math.round(val);
  if (Math.abs(n % 10) === 5) return Math.floor(n / 10) * 10;
  return n;
}

// Cerrar modal al hacer click fuera
document.getElementById('modal').addEventListener('click', (e)=>{
  if (e.target.id === 'modal') e.target.style.display = 'none';
});

// Vista individual (4 cuadros)
function toggleIndividualView(){
  const container = document.getElementById('individual-view');
  const active = container.style.display !== 'none';
  if (!active){
    container.style.display = 'grid';
    rebuildIndividualCharts();
  } else {
    destroyIndividualCharts();
    container.style.display = 'none';
  }
}

function rebuildIndividualCharts(){
  const container = document.getElementById('individual-view');
  container.innerHTML = '';
  destroyIndividualCharts();
  individualCharts = [];

  Object.keys(actions).forEach(name=>{
    const panel = document.createElement('div');
    panel.className = 'panel';
    const title = document.createElement('h3');
    title.textContent = name;
    const canvas = document.createElement('canvas');
    panel.appendChild(title);
    panel.appendChild(canvas);
    container.appendChild(panel);

    const color = actions[name].color;

    const c = new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        labels: Array.from({length: totalTurns}, (_, i) => i + 1),
        datasets: [{
          label: name,
          data: actions[name].values,
          borderColor: color,
          backgroundColor: color,
          borderWidth: 3,
          tension: 0,
          pointStyle: actions[name].pointStyle,
          pointRadius: actions[name].pointRadius,
          pointBorderWidth: actions[name].pointBorderWidth,
          pointBorderColor: color
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { top: 30 } },
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: '#eee' }, ticks: { color: '#333' } },
          y: { min: 10, max: 250, grid: { color: '#eee' }, ticks: { color: '#333' } }
        }
      },
      plugins: [overflowLabelPlugin]
    });
    individualCharts.push(c);
  });
}

function destroyIndividualCharts(){
  individualCharts.forEach(c => { try { c.destroy(); } catch(e){} });
  individualCharts = [];
}

function syncIndividualCharts(){
  if (document.getElementById('individual-view').style.display === 'none') return;
  individualCharts.forEach(c=>{
    const name = c.data.datasets[0].label;
    const color = actions[name].color;
    c.data.labels = Array.from({length: totalTurns}, (_, i) => i + 1);
    c.data.datasets[0].data = actions[name].values;
    c.data.datasets[0].borderColor = color;
    c.data.datasets[0].backgroundColor = color;
    c.data.datasets[0].pointBorderColor = color;
    c.data.datasets[0].pointStyle = actions[name].pointStyle;
    c.data.datasets[0].pointRadius = actions[name].pointRadius;
    c.data.datasets[0].pointBorderWidth = actions[name].pointBorderWidth;
    c.update();
  });
}
</script>
</body>
</html>
